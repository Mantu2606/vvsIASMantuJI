@model FossTech.Models.StudyMaterialModels.StudyMaterial

@{
	ViewData["Title"] = "Create";
}
<div class="col-sm-12">
	<div class="card shadow-sm">
		<div class="card-header d-flex justify-content-between align-items-center pb-1">
			<h2 class="mb-0">Add Study Material</h2>
		</div>
		<div asp-validation-summary="All" class="text-danger"></div>
		<div class="card-body">
			<form asp-action="Create" enctype="multipart/form-data">
				<div asp-validation-summary="ModelOnly" class="text-danger"></div>

				<div class="row">
					<div class="form-group col-md-6">
						<label asp-for="Name" class="control-label">Material Name</label>
						<input asp-for="Name" class="form-control" placeholder="Enter material name" />
						<span asp-validation-for="Name" class="text-danger"></span>
					</div>
					<div class="form-group col-md-6">
						<label asp-for="ThumbnailImage" class="control-label">Thumbnail Image</label>
						<input name="formImage" type="file" accept="image/*" class="form-control" style="border-radius: 10px;" onchange="checkImageSize(event)" />
						<span asp-validation-for="ThumbnailImage" class="text-danger"></span>
					</div>
				</div>

				<div class="row">
					<div class="form-group col-md-3">
						<label asp-for="BoardId" class="control-label">Board</label>
						<select asp-for="BoardId" class="form-control" asp-items="ViewBag.BoardId" onchange="getStandards()">
							<option value="">Select Board</option>
						</select>
					</div>
					<div class="form-group col-md-3">
						<label asp-for="StandardId" class="control-label">Standard</label>
						<select asp-for="StandardId" class="form-control" asp-items="ViewBag.StandardId" onchange="getSubjects()">
							<option value="">Select Standard</option>
						</select>
					</div>
					<div class="form-group col-md-3">
						<label asp-for="SubjectId" class="control-label">Subject</label>
						<select asp-for="SubjectId" class="form-control" asp-items="ViewBag.SubjectId" onchange="getChapters()">
							<option value="">Select Subject</option>
						</select>
					</div>
					<div class="form-group col-md-3">
						<label asp-for="ChapterId" class="control-label">Chapter</label>
						<select asp-for="ChapterId" class="form-control" asp-items="ViewBag.ChapterId">
							<option value="">Select Chapter</option>
						</select>
					</div>
				</div>

				<div class="row">
					<div class="form-group col-md-6">
						<label class="control-label">Upload PDFs</label>
						<input type="file" multiple name="PDFs" class="form-control" />
					</div>
					<div class="col-md-2"></div>
					<div class="form-group">
						<label asp-for="IsPaid" class="control-label">Paid</label>
						<input asp-for="IsPaid" type="checkbox" id="IsPaid" />
						<span>Check this box if the material is paid</span>
					</div>
					<div class="form-group col-md-4">
						<label asp-for="SortOrder" class="control-label">Sort Order</label>
						<input asp-for="SortOrder" class="form-control" placeholder="Enter sort order number" />
						<span asp-validation-for="SortOrder" class="text-danger"></span>
					</div>
				</div>
				<div id="priceFields" style="display:none;">
					<div class="row">
						<div class="form-group col-md-4">
							<label asp-for="BasePrice" class="control-label"></label>
							<input asp-for="BasePrice" class="form-control" placeholder="Enter base price" />
							<span asp-validation-for="BasePrice" class="text-danger"></span>
						</div>
						<div class="form-group col-md-4">
							<label asp-for="DiscountAmount" class="control-label"></label>
							<input asp-for="DiscountAmount" class="form-control" placeholder="Enter discounted price" />
							<span asp-validation-for="DiscountAmount" class="text-danger"></span>
						</div>
						<div class="form-group col-md-4">
							<label asp-for="FinalPrice" class="control-label"></label>
							<input asp-for="FinalPrice" class="form-control" placeholder="Enter final price" id="FinalPrice" disabled="disabled" />
							<span asp-validation-for="FinalPrice" class="text-danger"></span>
						</div>
					</div>
				</div>
				<div class="form-group text-center">
					<input type="submit" value="Create" class="btn btn-success btn-lg" />
				</div>
			</form>
		</div>
	</div>

	<div class="mt-3 text-center">
		<a asp-action="Index" class="btn btn-info btn-sm">Back to List</a>
	</div>
</div>



@section Scripts {
	@{
		await Html.RenderPartialAsync("_ValidationScriptsPartial");
	}
	<script>
		function checkImageSize(event) {
			const fileInput = event.target;
			if (fileInput.files && fileInput.files[0]) {
				const fileSize = fileInput.files[0].size; // Size in bytes
				const maxSize = 250 * 1024; // 250KB in bytes

				const errorMessageSpan = document.querySelector('[data-valmsg-for="ThumbnailImage"]');
				if (fileSize > maxSize) {
					errorMessageSpan.textContent = "Please upload an image size up to 250KB.";
					// Clear the file input to prevent submitting the form with an oversized image
					fileInput.value = null;
				} else {
					errorMessageSpan.textContent = ""; // Clear any previous error message
				}
			}
		}
		function getStandards() {
			var boardId = $('select[name="BoardId"]').val();
			if (boardId) {
				$.getJSON('@Url.Action("GetStandardsByBoardId", "StudyMaterials")', { boardId: boardId }, function(data) {
					var options = '<option value="">Select Standard</option>';
					$.each(data, function(i, item) {
						options += '<option value="' + item.id + '">' + item.name + '</option>';
					});
					$('select[name="StandardId"]').html(options);
					getSubjects(); // Reload subjects based on new standard
				});
			} else {
				$('select[name="StandardId"]').html('<option value="">Select Standard</option>');
				$('select[name="SubjectId"]').html('<option value="">Select Subject</option>');
				$('select[name="ChapterId"]').html('<option value="">Select Chapter</option>');
			}
		}

		function getSubjects() {
			var standardId = $('select[name="StandardId"]').val();
			if (standardId) {
				$.getJSON('@Url.Action("GetSubjectsByStandardId", "StudyMaterials")', { standardId: standardId }, function(data) {
					var options = '<option value="">Select Subject</option>';
					$.each(data, function(i, item) {
						options += '<option value="' + item.id + '">' + item.name + '</option>';
					});
					$('select[name="SubjectId"]').html(options);
					getChapters(); // Reload chapters based on new subject
				});
			} else {
				$('select[name="SubjectId"]').html('<option value="">Select Subject</option>');
				$('select[name="ChapterId"]').html('<option value="">Select Chapter</option>');
			}
		}

		function getChapters() {
			var subjectId = $('select[name="SubjectId"]').val();
			if (subjectId) {
				$.getJSON('@Url.Action("GetChaptersBySubjectId", "StudyMaterials")', { subjectId: subjectId }, function(data) {
					var options = '<option value="">Select Chapter</option>';
					$.each(data, function(i, item) {
						options += '<option value="' + item.id + '">' + item.name + '</option>';
					});
					$('select[name="ChapterId"]').html(options);
				});
			} else {
				$('select[name="ChapterId"]').html('<option value="">Select Chapter</option>');
			}
		}
		// onchange = "checkImageSize(event)"
	</script>
	<script>
		function togglePriceFields() {
			var isPaid = $('#IsPaid').is(':checked');
			if (isPaid) {
				$('#priceFields').show();
			} else {
				$('#priceFields').hide();
			}
		}
		$(document).ready(function(){
			togglePriceFields();
			$('#IsPaid').change(function(){
				togglePriceFields();
			});
			var BasePrice = $('#BasePrice');
			var DiscountAmount = $('#DiscountAmount');
			var FinalPrice = $('#FinalPrice');
			BasePrice.on('change', function() {
				FinalPrice.val((BasePrice.val() - DiscountAmount.val()).toFixed(2));
			});
			DiscountAmount.on('change', function() {
				FinalPrice.val((BasePrice.val() - DiscountAmount.val()).toFixed(2));
			});
		});
	</script>
}
